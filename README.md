# LinuxæœåŠ¡å™¨è™šæ‹Ÿå†…å­˜ä¸“ä¸šçº§ä¼˜åŒ–è„šæœ¬

<div align="center">

![Version](https://img.shields.io/badge/version-3.1-blue.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)
![Platform](https://img.shields.io/badge/platform-Linux-lightgrey.svg)

**ä½¿ç”¨ä¸šç•Œæ ‡å‡†æµ‹è¯•å·¥å…·å’Œå•†ä¸šçº§ç®—æ³•ï¼Œè‡ªåŠ¨ä¼˜åŒ–LinuxæœåŠ¡å™¨è™šæ‹Ÿå†…å­˜é…ç½®**

</div>

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä¸€é”®å®‰è£…è¿è¡Œ

```bash
wget -qO- https://raw.githubusercontent.com/jiaqp/release_temp/refs/heads/main/optimize_vm_enterprise.sh | sudo bash
```

æˆ–ä½¿ç”¨curlï¼š

```bash
curl -fsSL https://raw.githubusercontent.com/jiaqp/release_temp/refs/heads/main/optimize_vm_enterprise.sh | sudo bash
```

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ”¬ **ç²¾å‡†æ€§èƒ½æµ‹è¯•**
- âœ… **CPUæµ‹è¯•**ï¼šSysbenchå•çº¿ç¨‹æµ‹è¯•ï¼ˆå¯¹æ ‡ [spiritLHLS/ecs](https://github.com/spiritLHLS/ecs) é¡¹ç›®ï¼‰
- âœ… **å†…å­˜æµ‹è¯•**ï¼šSysbenchè¯»å–å¸¦å®½æµ‹è¯•ï¼ˆå¯¹æ ‡Lemonbenchæ ‡å‡†ï¼‰
- âœ… **ç£ç›˜æµ‹è¯•**ï¼šFIOä¸“ä¸šå·¥å…·ï¼Œç›´æ¥æ¨¡å¼ç»•è¿‡ç¼“å­˜ï¼Œæµ‹è¯•çœŸå®4K IOPS

### ğŸ§® **å•†ä¸šçº§ä¼˜åŒ–ç®—æ³•**
- âœ… åŸºäº **Google SREã€Red Hat Enterpriseã€Oracle Linux** æœ€ä½³å®è·µ
- âœ… æ™ºèƒ½è™šæ‹ŸåŒ–ç¯å¢ƒæ£€æµ‹å’Œé’ˆå¯¹æ€§ä¼˜åŒ–
- âœ… å¤šå› å­åŠ æƒæ¨¡å‹ï¼šç£ç›˜IOPSä¸»å¯¼ï¼ˆ90%ï¼‰+ CPU/å†…å­˜å¾®è°ƒï¼ˆ10%ï¼‰
- âœ… è‡ªåŠ¨è®¡ç®—10ä¸ªå…³é”®VMå‚æ•°

### ğŸ¤– **å…¨è‡ªåŠ¨åŒ–**
- âœ… è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…ä¾èµ–å·¥å…·
- âœ… è‡ªåŠ¨è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼ˆçº¦1åˆ†é’Ÿï¼‰
- âœ… è‡ªåŠ¨å¯¹æ¯”å½“å‰é…ç½®ä¸æ¨èé…ç½®
- âœ… è‡ªåŠ¨åº”ç”¨ä¼˜åŒ–ï¼ˆ3ç§’å€’è®¡æ—¶ï¼‰
- âœ… è‡ªåŠ¨å¤‡ä»½åŸé…ç½®æ–‡ä»¶

---

## ğŸ“Š ä¼˜åŒ–çš„è™šæ‹Ÿå†…å­˜å‚æ•°

| å‚æ•° | è¯´æ˜ | ä¼˜åŒ–ä¾æ® |
|------|------|----------|
| `vm.swappiness` | Swapä½¿ç”¨å€¾å‘ | åŸºäºRAMå¤§å°å’Œç£ç›˜IOPS |
| `Swapå¤§å°` | äº¤æ¢ç©ºé—´å®¹é‡ | ä¸‰å› å­æ¨¡å‹ï¼ˆCPU+å†…å­˜+ç£ç›˜ï¼‰ |
| `vm.vfs_cache_pressure` | ç¼“å­˜å›æ”¶ç­–ç•¥ | åŸºäºç£ç›˜IOPS |
| `vm.dirty_ratio` | è„é¡µä¸Šé™ | åŸºäºRAMå¤§å°å’Œå†™å…¥IOPS |
| `vm.dirty_background_ratio` | åå°å†™å›é˜ˆå€¼ | dirty_ratioçš„1/4 |
| `vm.dirty_expire_centisecs` | è„é¡µè¿‡æœŸæ—¶é—´ | åŸºäºå†™å…¥IOPS |
| `vm.dirty_writeback_centisecs` | å†™å›é—´éš” | åŸºäºç£ç›˜ç±»å‹ |
| `vm.min_free_kbytes` | æœ€å°ç©ºé—²å†…å­˜ | åŸºäºRAMå¤§å°å’ŒCPUæ ¸å¿ƒæ•° |
| `vm.page_cluster` | Swapé¡µé¢èšç°‡ | åŸºäºç£ç›˜ç±»å‹ |
| `vm.overcommit_memory/ratio` | å†…å­˜è¶…é¢ç­–ç•¥ | åŸºäºRAMå¤§å° |

---

## ğŸ¯ é€‚ç”¨åœºæ™¯

### âœ… æ¨èä½¿ç”¨
- WebæœåŠ¡å™¨ï¼ˆNginxã€Apacheï¼‰
- åº”ç”¨æœåŠ¡å™¨ï¼ˆJavaã€Pythonã€Node.jsï¼‰
- æ•°æ®åº“æœåŠ¡å™¨ï¼ˆMySQLã€PostgreSQLã€MongoDBï¼‰
- å®¹å™¨ä¸»æœºï¼ˆDockerã€Kubernetesï¼‰
- è™šæ‹ŸåŒ–å®¿ä¸»æœºï¼ˆKVMã€Xenï¼‰
- VPS/äº‘æœåŠ¡å™¨

### âš ï¸ ç‰¹åˆ«ä¼˜åŒ–
- **æå°å†…å­˜ç¯å¢ƒ**ï¼ˆ<1GBï¼‰ï¼šè‡ªåŠ¨é‡‡ç”¨æ¿€è¿›swapç­–ç•¥ï¼Œé¿å…OOM
- **è™šæ‹ŸåŒ–ç¯å¢ƒ**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶é’ˆå¯¹ä½IOPSä¼˜åŒ–
- **ä½æ€§èƒ½ç£ç›˜**ï¼šè‡ªåŠ¨å¢åŠ swapç¼“å†²ï¼Œé™ä½swappiness

---

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

### æ”¯æŒçš„æ“ä½œç³»ç»Ÿ
- âœ… Ubuntu 16.04+
- âœ… Debian 8+
- âœ… CentOS/RHEL 7+
- âœ… Rocky Linux 8+
- âœ… AlmaLinux 8+
- âœ… å…¶ä»–ä¸»æµLinuxå‘è¡Œç‰ˆ

### ä¾èµ–å·¥å…·ï¼ˆè‡ªåŠ¨å®‰è£…ï¼‰
- `fio` - ä¸“ä¸šå­˜å‚¨æ€§èƒ½æµ‹è¯•
- `sysbench` - ç»¼åˆæ€§èƒ½åŸºå‡†æµ‹è¯•
- `bc` - æ•°å­¦è®¡ç®—
- `sysctl` - ç³»ç»Ÿå‚æ•°é…ç½®

---

## ğŸ” å·¥ä½œæµç¨‹

```
1ï¸âƒ£  æ£€æµ‹rootæƒé™å’Œä¾èµ–å·¥å…·
     â†“
2ï¸âƒ£  æ‰§è¡Œæ·±åº¦æ€§èƒ½æµ‹è¯•
     â”œâ”€ CPUï¼šSysbenchå•çº¿ç¨‹æµ‹è¯•ï¼ˆ5ç§’ï¼‰
     â”œâ”€ å†…å­˜ï¼šSysbenchè¯»å–å¸¦å®½æµ‹è¯•ï¼ˆ5ç§’ï¼‰
     â””â”€ ç£ç›˜ï¼šFIO 4K IOPSæµ‹è¯•ï¼ˆ30ç§’ï¼‰
     â†“
3ï¸âƒ£  å•†ä¸šçº§ç®—æ³•è®¡ç®—æœ€ä¼˜å‚æ•°
     â”œâ”€ Swapå¤§å°ï¼ˆä¸‰å› å­åŠ æƒæ¨¡å‹ï¼‰
     â”œâ”€ Swappinesså€¼
     â””â”€ 8ä¸ªé«˜çº§VMå‚æ•°
     â†“
4ï¸âƒ£  å¯¹æ¯”å½“å‰é…ç½®ä¸æ¨èé…ç½®
     â””â”€ æ˜¾ç¤ºå·®å¼‚ï¼Œæ ‡æ³¨éœ€è¦å˜æ›´çš„å‚æ•°
     â†“
5ï¸âƒ£  è‡ªåŠ¨åº”ç”¨ä¼˜åŒ–
     â”œâ”€ å¤‡ä»½åŸé…ç½®åˆ° /etc/sysctl.conf.backup.*
     â”œâ”€ å®æ—¶åº”ç”¨å‚æ•°ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
     â”œâ”€ å†™å…¥ /etc/sysctl.confï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰
     â””â”€ ç®¡ç†Swapç©ºé—´
```

---

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰

```bash
# ä¸‹è½½å¹¶æ‰§è¡Œï¼ˆè‡ªåŠ¨åº”ç”¨æ‰€æœ‰ä¼˜åŒ–ï¼‰
wget -qO- https://raw.githubusercontent.com/jiaqp/release_temp/refs/heads/main/optimize_vm_enterprise.sh | sudo bash
```

### æ‰‹åŠ¨ä¸‹è½½åæ‰§è¡Œ

```bash
# ä¸‹è½½è„šæœ¬
wget https://raw.githubusercontent.com/jiaqp/release_temp/refs/heads/main/optimize_vm_enterprise.sh

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x optimize_vm_enterprise.sh

# è¿è¡Œè„šæœ¬
sudo ./optimize_vm_enterprise.sh
```

### ç¦ç”¨é¢œè‰²è¾“å‡º

```bash
wget https://raw.githubusercontent.com/jiaqp/release_temp/refs/heads/main/optimize_vm_enterprise.sh
sudo bash optimize_vm_enterprise.sh --no-color
```

---

## ğŸ“ˆ ç¤ºä¾‹è¾“å‡º

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     ç³»ç»Ÿç¡¬ä»¶é…ç½®ä¿¡æ¯                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CPU:
  Intel(R) Xeon(R) CPU E5-2683 v4 @ 2.10GHz
  æ ¸å¿ƒæ•°: 1, é¢‘ç‡: 2099 MHz
  æ€§èƒ½: 802 events/sec â­ä¼˜åŒ–å…³é”®æŒ‡æ ‡

å†…å­˜:
  å®¹é‡: 0.45 GB
  ç±»å‹: DDR4-2400 ECC
  è¯»å–å¸¦å®½: 17999 MB/s â­ä¼˜åŒ–å…³é”®æŒ‡æ ‡

ç£ç›˜:
  è®¾å¤‡: /dev/vda (HDD)
  ç±»å‹: 7200 RPM SATA HDD
  è™šæ‹ŸåŒ–: æ˜¯ï¼ˆå®¿ä¸»æœºSSDï¼Œè™šæ‹Ÿç›˜IOPSå—é™ï¼‰
  é¡ºåºè¯»å–: 3190 MB/s
  4KéšæœºIOPS: è¯»100 / å†™80 â­ä¼˜åŒ–å…³é”®æŒ‡æ ‡

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   å•†ä¸šçº§ä¼˜åŒ–å‚æ•°æ¨è                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ ¸å¿ƒå‚æ•°:
  vm.swappiness                = 45
  æ¨èSwapå¤§å°                 = 940 MB (.91 GB)

è„é¡µç®¡ç†å‚æ•°:
  vm.dirty_ratio               = 5
  vm.dirty_background_ratio    = 3
  vm.dirty_expire_centisecs    = 3000
  vm.dirty_writeback_centisecs = 500

å†…å­˜ç®¡ç†å‚æ•°:
  vm.vfs_cache_pressure        = 50
  vm.min_free_kbytes           = 16384 KB
  vm.page_cluster              = 3
  vm.overcommit_memory         = 2
  vm.overcommit_ratio          = 50
```

---

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§ï¼ˆv3.1 å¢å¼ºï¼‰

- âœ… **è‡ªåŠ¨å¤‡ä»½**ï¼šä¿®æ”¹å‰è‡ªåŠ¨å¤‡ä»½ `/etc/sysctl.conf`
- âœ… **ç£ç›˜ç©ºé—´æ£€æµ‹**ï¼šç©ºé—´ä¸è¶³æ—¶è·³è¿‡å¤‡ä»½ä½†ä»åº”ç”¨é…ç½®
- âœ… **å‚æ•°éªŒè¯**ï¼šæ‰€æœ‰å‚æ•°éƒ½æœ‰åˆç†èŒƒå›´é™åˆ¶
- âœ… **åˆ†é˜¶æ®µåº”ç”¨**ï¼šå…ˆåº”ç”¨å®‰å…¨å‚æ•° â†’ åˆ›å»ºswap â†’ å†åº”ç”¨overcommit
- âœ… **å®‰å…¨æ£€æŸ¥**ï¼šåº”ç”¨å‰æ£€æŸ¥å¯ç”¨å†…å­˜ã€ç£ç›˜ç©ºé—´ã€ç³»ç»ŸçŠ¶æ€
- âœ… **è‡ªåŠ¨å›æ»š**ï¼šæ£€æµ‹åˆ°å†…å­˜åˆ†é…å¤±è´¥æ—¶è‡ªåŠ¨æ¢å¤å®‰å…¨è®¾ç½®
- âœ… **æ°¸ä¸ä½¿ç”¨overcommit_memory=2**ï¼šé¿å…ä¸¥æ ¼é™åˆ¶å¯¼è‡´æ— æ³•åˆ†é…å†…å­˜
- âœ… **å°å†…å­˜ä¿æŠ¤**ï¼šæå°å†…å­˜ç³»ç»Ÿä¸é™ä½min_free_kbytes
- âœ… **å¯å›æ»š**ï¼šä¿ç•™åŸé…ç½®å¤‡ä»½ï¼Œå¯éšæ—¶æ¢å¤

### ğŸ†˜ ç´§æ€¥æƒ…å†µå¤„ç†

å¦‚æœé‡åˆ° "Cannot allocate memory" é”™è¯¯ï¼Œè¯·æŸ¥çœ‹ [ç´§æ€¥æ¢å¤æŒ‡å—](./EMERGENCY_RECOVERY.md)

---

## ğŸ”§ é«˜çº§é€‰é¡¹

### æ‰‹åŠ¨å›æ»šé…ç½®

```bash
# æŸ¥æ‰¾å¤‡ä»½æ–‡ä»¶
ls -lt /etc/sysctl.conf.backup.*

# æ¢å¤åŸé…ç½®
sudo cp /etc/sysctl.conf.backup.YYYYMMDD_HHMMSS /etc/sysctl.conf
sudo sysctl -p
```

### ç¦ç”¨é¢œè‰²è¾“å‡º

```bash
sudo bash optimize_vm_enterprise.sh --no-color
```

---

## ğŸ“š æŠ€æœ¯æ–‡æ¡£

### ç®—æ³•åŸç†

#### Swapå¤§å°è®¡ç®—
```
optimal_swap = base_swap Ã— cpu_factor Ã— mem_speed_factor Ã— disk_factor

å…¶ä¸­ï¼š
- base_swap: åŸºäºRAMå¤§å°ï¼ˆ<1GBä¸ºRAMÃ—1.4ï¼‰
- cpu_factor: 0.97-1.03ï¼ˆåŸºäºCPUæ€§èƒ½ï¼‰
- mem_speed_factor: 0.98-1.02ï¼ˆåŸºäºå†…å­˜å¸¦å®½ï¼‰
- disk_factor: 0.70-1.45ï¼ˆåŸºäºç£ç›˜IOPSï¼Œä¸»å¯¼å› ç´ ï¼‰
```

#### Swappinessè®¡ç®—
```
swappiness = base_swappiness + disk_adjustment

å…¶ä¸­ï¼š
- base_swappiness: 60â†’40â†’30â†’20â†’10â†’5â†’1ï¼ˆåŸºäºRAMå¤§å°ï¼‰
- disk_adjustment: -20åˆ°+2ï¼ˆåŸºäºç£ç›˜IOPSï¼‰
```

### æ€§èƒ½æµ‹è¯•æ ‡å‡†

å‚è€ƒé¡¹ç›®ï¼š[spiritLHLS/ecs](https://github.com/spiritLHLS/ecs) - ä¸šç•ŒçŸ¥åçš„VPSæµ‹è¯„æ ‡å‡†

- **CPU**: Sysbench CPUæµ‹è¯•ï¼ˆç´ æ•°10000ï¼Œ5ç§’ï¼‰
- **å†…å­˜**: Sysbench Memoryè¯»å–æµ‹è¯•
- **ç£ç›˜**: FIO 4KéšæœºIOPSæµ‹è¯•ï¼ˆDirectæ¨¡å¼ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **éœ€è¦rootæƒé™**ï¼šè„šæœ¬éœ€è¦ä¿®æ”¹ç³»ç»Ÿé…ç½®
2. **æµ‹è¯•æ—¶é—´**ï¼šå®Œæ•´æµ‹è¯•çº¦éœ€1åˆ†é’Ÿ
3. **ç£ç›˜IO**ï¼šæµ‹è¯•æœŸé—´ä¼šäº§ç”Ÿç£ç›˜IOè´Ÿè½½
4. **è‡ªåŠ¨åº”ç”¨**ï¼šè„šæœ¬ä¼šè‡ªåŠ¨åº”ç”¨ä¼˜åŒ–ï¼Œ3ç§’å€’è®¡æ—¶
5. **é‡å¯å»ºè®®**ï¼šä¼˜åŒ–åå»ºè®®é‡å¯ç³»ç»Ÿä»¥ç¡®ä¿æ‰€æœ‰è®¾ç½®å®Œå…¨ç”Ÿæ•ˆ

## ğŸ”§ ç‰ˆæœ¬å†å²

### v3.1 (2024-12-13) - å®‰å…¨æ€§å¢å¼º
- ğŸ›¡ï¸ **ä¿®å¤å…³é”®bug**ï¼šæ°¸ä¸ä½¿ç”¨ `overcommit_memory=2`ï¼Œé¿å…å†…å­˜åˆ†é…å¤±è´¥
- ğŸ”„ **ä¼˜åŒ–åº”ç”¨é¡ºåº**ï¼šåˆ†é˜¶æ®µåº”ç”¨å‚æ•°ï¼ˆå®‰å…¨å‚æ•° â†’ åˆ›å»ºswap â†’ overcommitï¼‰
- ğŸ›¡ï¸ **å°å†…å­˜ä¿æŠ¤**ï¼šæå°å†…å­˜ç³»ç»Ÿ(<512MB)ä¸é™ä½ `min_free_kbytes`
- âœ… **å®‰å…¨æ£€æŸ¥æœºåˆ¶**ï¼šåº”ç”¨å‰æ£€æŸ¥å†…å­˜ã€ç£ç›˜ã€ç³»ç»ŸçŠ¶æ€
- ğŸ”™ **è‡ªåŠ¨å›æ»š**ï¼šæ£€æµ‹åˆ°é—®é¢˜æ—¶è‡ªåŠ¨æ¢å¤å®‰å…¨è®¾ç½®
- ğŸ“š **ç´§æ€¥æ¢å¤æŒ‡å—**ï¼šæä¾›è¯¦ç»†çš„æ•…éšœæ¢å¤æ­¥éª¤

### v3.0 (2024-12-10)
- åˆå§‹å‘å¸ƒï¼Œä¸šç•Œæ ‡å‡†æµ‹è¯•+å•†ä¸šçº§ç®—æ³•

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

---

## ğŸ“„ è®¸å¯è¯

MIT License

---

## ğŸ™ è‡´è°¢

- [spiritLHLS/ecs](https://github.com/spiritLHLS/ecs) - CPUæµ‹è¯•æ ‡å‡†å‚è€ƒ
- [LemonBench](https://github.com/LemonBench/LemonBench) - å†…å­˜æµ‹è¯•æ ‡å‡†å‚è€ƒ
- Google SREã€Red Hatã€Oracle - ä¼˜åŒ–ç®—æ³•å‚è€ƒ

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤Issueã€‚

---

<div align="center">

**â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸€ä¸ªStarï¼â­**

</div>

